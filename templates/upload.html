{% extends "base.html" %}

{% block title %}Upload Data - Fraud Detection System{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <!-- Header -->
            <div class="text-center mb-5">
                <h1 class="display-5">
                    <i class="fas fa-upload text-primary me-3"></i>
                    Upload Transaction Data
                </h1>
                <p class="lead text-muted">Upload your credit card transaction dataset for fraud detection analysis</p>
            </div>

            <!-- Upload Form -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-file-csv me-2"></i>
                        CSV File Upload Options
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Upload Method Selection -->
                    <div class="mb-4">
                        <h6>Choose Upload Method:</h6>
                        <div class="btn-group" role="group" aria-label="Upload method selection">
                            <input type="radio" class="btn-check" name="uploadMethod" id="directUpload" value="direct" checked>
                            <label class="btn btn-outline-primary" for="directUpload">
                                <i class="fas fa-database me-2"></i>Direct Upload (Small Files)
                            </label>

                            <input type="radio" class="btn-check" name="uploadMethod" id="kafkaUpload" value="kafka">
                            <label class="btn btn-outline-success" for="kafkaUpload">
                                <i class="fas fa-stream me-2"></i>Kafka Streaming (Large Files)
                            </label>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted" id="upload-method-description">
                                Direct upload: Best for files under 10MB. Saves directly to database.
                            </small>
                        </div>
                    </div>

                    <!-- Direct Upload Form -->
                    <form method="POST" enctype="multipart/form-data" id="direct-upload-form">
                        <div class="mb-4">
                            <label for="file" class="form-label">Select CSV File</label>
                            <input type="file" class="form-control" id="file" name="file" accept=".csv" required>
                            <div class="form-text">
                                Upload a CSV file containing transaction data with the required columns.
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg" id="direct-upload-btn">
                                <i class="fas fa-upload me-2"></i>
                                Upload to Database
                            </button>
                        </div>
                    </form>

                    <!-- Kafka Upload Form -->
                    <form id="kafka-upload-form" style="display: none;" enctype="multipart/form-data">
                        <div class="mb-4">
                            <label for="kafka-file" class="form-label">Select CSV File</label>
                            <input type="file" class="form-control" id="kafka-file" name="file" accept=".csv" required>
                            <div class="form-text">
                                Upload via Kafka streaming for real-time processing and fraud detection.
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="real-time-processing" checked>
                                <label class="form-check-label" for="real-time-processing">
                                    Enable real-time fraud detection during upload
                                </label>
                            </div>
                        </div>
                        
                        <div id="kafka-upload-progress" class="mb-3" style="display: none;">
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                            </div>
                            <small class="text-muted">Processing through Kafka...</small>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-success btn-lg" onclick="uploadViaKafka()">
                                <i class="fas fa-stream me-2"></i>
                                Stream via Kafka
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Upload Results -->
            <div class="card mt-4" id="upload-results" style="display: none;">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        Upload Results
                    </h5>
                </div>
                <div class="card-body">
                    <div id="upload-results-content">
                        <!-- Results will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Data Format Information -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Upload Methods Comparison
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-database text-primary me-2"></i>Direct Upload</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-check text-success me-2"></i>Best for files under 10MB</li>
                                <li><i class="fas fa-check text-success me-2"></i>Faster for small datasets</li>
                                <li><i class="fas fa-check text-success me-2"></i>Direct database storage</li>
                                <li><i class="fas fa-check text-success me-2"></i>Immediate availability</li>
                                <li><i class="fas fa-times text-warning me-2"></i>No real-time processing</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-stream text-success me-2"></i>Kafka Streaming</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-check text-success me-2"></i>Best for files up to 100MB</li>
                                <li><i class="fas fa-check text-success me-2"></i>Real-time fraud detection</li>
                                <li><i class="fas fa-check text-success me-2"></i>High throughput processing</li>
                                <li><i class="fas fa-check text-success me-2"></i>Streaming architecture</li>
                                <li><i class="fas fa-check text-success me-2"></i>Live monitoring available</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-lightbulb me-2"></i>
                        <strong>Recommendation:</strong> Use Direct Upload for quick testing with small files. Use Kafka Streaming for production workloads and large datasets where you want real-time fraud detection.
                    </div>
                </div>
            </div>

            <!-- Data Format Requirements -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-table me-2"></i>
                        Required Data Format
                    </h5>
                </div>
                <div class="card-body">
                    <p>Your CSV file should contain the following columns:</p>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Required Columns:</h6>
                            <ul class="list-unstyled">
                                <li><code>Time</code> - Transaction time</li>
                                <li><code>V1</code> to <code>V28</code> - PCA-transformed features</li>
                                <li><code>Amount</code> - Transaction amount</li>
                                <li><code>Class</code> - Fraud label (0=normal, 1=fraud)</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>Data Requirements:</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-check text-success me-2"></i>CSV format</li>
                                <li><i class="fas fa-check text-success me-2"></i>Numerical data</li>
                                <li><i class="fas fa-check text-success me-2"></i>No missing values</li>
                                <li><i class="fas fa-check text-success me-2"></i>Header row included</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="alert alert-success mt-3">
                        <i class="fas fa-cog me-2"></i>
                        <strong>Automatic Processing:</strong> Both upload methods handle data preprocessing, feature scaling, and validation automatically for optimal model performance.
                    </div>
                </div>
            </div>

            <!-- Sample Data Preview -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-table me-2"></i>
                        Sample Data Format
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>V1</th>
                                    <th>V2</th>
                                    <th>...</th>
                                    <th>V28</th>
                                    <th>Amount</th>
                                    <th>Class</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>0</td>
                                    <td>-1.359807</td>
                                    <td>-0.072781</td>
                                    <td>...</td>
                                    <td>-0.021053</td>
                                    <td>149.62</td>
                                    <td>0</td>
                                </tr>
                                <tr>
                                    <td>1</td>
                                    <td>1.191857</td>
                                    <td>0.266151</td>
                                    <td>...</td>
                                    <td>0.014724</td>
                                    <td>2.69</td>
                                    <td>0</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <div class="text-center mt-4">
                <a href="{{ url_for('index') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i>
                    Back to Dashboard
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Upload method selection
document.addEventListener('DOMContentLoaded', function() {
    const directRadio = document.getElementById('directUpload');
    const kafkaRadio = document.getElementById('kafkaUpload');
    const directForm = document.getElementById('direct-upload-form');
    const kafkaForm = document.getElementById('kafka-upload-form');
    const description = document.getElementById('upload-method-description');
    
    // Method change handler
    function updateUploadMethod() {
        if (directRadio.checked) {
            directForm.style.display = 'block';
            kafkaForm.style.display = 'none';
            description.textContent = 'Direct upload: Best for files under 10MB. Saves directly to database.';
        } else {
            directForm.style.display = 'none';
            kafkaForm.style.display = 'block';
            description.textContent = 'Kafka streaming: Best for large files. Real-time processing and fraud detection.';
        }
    }
    
    directRadio.addEventListener('change', updateUploadMethod);
    kafkaRadio.addEventListener('change', updateUploadMethod);
    
    // File validation for direct upload
    document.getElementById('file').addEventListener('change', function(e) {
        validateFile(e.target, false);
    });
    
    // File validation for Kafka upload
    document.getElementById('kafka-file').addEventListener('change', function(e) {
        validateFile(e.target, true);
    });
    
    // Direct form submission handling
    document.getElementById('direct-upload-form').addEventListener('submit', function(e) {
        const fileInput = document.getElementById('file');
        if (!fileInput.files[0]) {
            e.preventDefault();
            alert('Please select a file to upload.');
            return;
        }
        
        // Show loading state
        const submitBtn = document.getElementById('direct-upload-btn');
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
        submitBtn.disabled = true;
    });
});

// File validation function
function validateFile(fileInput, isKafka) {
    const file = fileInput.files[0];
    if (file) {
        const fileName = file.name;
        const fileSize = file.size;
        
        // Check file extension
        if (!fileName.toLowerCase().endsWith('.csv')) {
            alert('Please select a CSV file.');
            fileInput.value = '';
            return false;
        }
        
        // Size limits
        const maxSize = isKafka ? 100 * 1024 * 1024 : 10 * 1024 * 1024; // 100MB for Kafka, 10MB for direct
        const sizeMB = fileSize / 1024 / 1024;
        
        if (fileSize > maxSize) {
            alert(`File size should be less than ${maxSize / 1024 / 1024}MB for ${isKafka ? 'Kafka' : 'direct'} upload.`);
            fileInput.value = '';
            return false;
        }
        
        // Suggest appropriate method based on file size
        if (!isKafka && sizeMB > 5) {
            const useKafka = confirm(`File is ${sizeMB.toFixed(2)}MB. Would you like to use Kafka streaming for better performance?`);
            if (useKafka) {
                document.getElementById('kafkaUpload').checked = true;
                document.getElementById('kafkaUpload').dispatchEvent(new Event('change'));
                document.getElementById('kafka-file').files = fileInput.files;
                fileInput.value = '';
                return false;
            }
        }
        
        return true;
    }
    return false;
}

// Kafka upload function
function uploadViaKafka() {
    const fileInput = document.getElementById('kafka-file');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('Please select a file to upload.');
        return;
    }
    
    const progressContainer = document.getElementById('kafka-upload-progress');
    const progressBar = progressContainer.querySelector('.progress-bar');
    const resultsContainer = document.getElementById('upload-results');
    const resultsContent = document.getElementById('upload-results-content');
    
    // Show progress
    progressContainer.style.display = 'block';
    progressBar.style.width = '10%';
    
    // Prepare form data
    const formData = new FormData();
    formData.append('file', file);
    
    // Upload via Kafka
    fetch('/kafka/batch-upload', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        progressBar.style.width = '50%';
        return response.json();
    })
    .then(data => {
        progressBar.style.width = '100%';
        
        setTimeout(() => {
            progressContainer.style.display = 'none';
            
            if (data.error) {
                resultsContent.innerHTML = `
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>Upload Failed</h6>
                        <p>${data.error}</p>
                        ${data.details ? `<small>${data.details}</small>` : ''}
                    </div>
                `;
            } else {
                resultsContent.innerHTML = `
                    <div class="alert alert-success">
                        <h6><i class="fas fa-check-circle me-2"></i>Upload Successful</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Total Transactions:</strong> ${data.total_transactions.toLocaleString()}
                            </div>
                            <div class="col-md-6">
                                <strong>Successfully Processed:</strong> ${data.sent_successfully.toLocaleString()}
                            </div>
                        </div>
                        ${data.failed > 0 ? `<p class="text-warning mt-2">Failed to process: ${data.failed} transactions</p>` : ''}
                        <hr>
                        <p class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            Data has been streamed through Kafka and is being processed for fraud detection in real-time.
                        </p>
                    </div>
                    <div class="d-grid gap-2 mt-3">
                        <a href="/kafka/dashboard" class="btn btn-info">
                            <i class="fas fa-chart-line me-2"></i>Monitor Processing
                        </a>
                        <a href="/dashboard" class="btn btn-primary">
                            <i class="fas fa-tachometer-alt me-2"></i>View Dashboard
                        </a>
                    </div>
                `;
            }
            
            resultsContainer.style.display = 'block';
        }, 1000);
    })
    .catch(error => {
        console.error('Error:', error);
        progressContainer.style.display = 'none';
        
        resultsContent.innerHTML = `
            <div class="alert alert-danger">
                <h6><i class="fas fa-exclamation-triangle me-2"></i>Upload Error</h6>
                <p>An error occurred during upload. Please try again.</p>
                <small>${error.message}</small>
            </div>
        `;
        resultsContainer.style.display = 'block';
    });
}
</script>
{% endblock %}
