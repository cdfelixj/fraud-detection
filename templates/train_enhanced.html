{% extends "base.html" %}

{% block title %}Train Models - Credit Card Fraud Detection{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-brain me-3"></i>Model Training & Configuration</h2>
        <a href="{{ url_for('index') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
        </a>
    </div>

    <!-- Model Status -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>Current Status
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <p><strong>Transactions:</strong> <span class="badge bg-primary">{{ transaction_count }}</span></p>
                            <p><strong>Models Status:</strong> 
                                {% if model_trained %}
                                    <span class="badge bg-success">Trained</span>
                                {% else %}
                                    <span class="badge bg-danger">Not Trained</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-6">
                            {% if latest_performance %}
                            <p><strong>Last Accuracy:</strong> {{ "%.3f"|format(latest_performance.accuracy_score) }}</p>
                            <p><strong>Last F1-Score:</strong> {{ "%.3f"|format(latest_performance.f1_score) }}</p>
                            {% else %}
                            <p class="text-muted">No performance metrics available</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cogs me-2"></i>Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('train_models') }}" style="display: inline;">
                        <input type="hidden" name="action" value="quick_train">
                        <button type="submit" class="btn btn-success w-100 mb-2" {% if transaction_count == 0 %}disabled{% endif %}>
                            <i class="fas fa-play me-2"></i>Quick Train (Default Settings)
                        </button>
                    </form>
                    <button class="btn btn-info w-100" onclick="loadDefaultParameters()">
                        <i class="fas fa-undo me-2"></i>Reset to Defaults
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Model Configuration -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-sliders-h me-2"></i>Model Parameters
            </h5>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('train_models') }}" id="trainingForm">
                <input type="hidden" name="action" value="custom_train">
                
                <div class="row">
                    <!-- Isolation Forest Parameters -->
                    <div class="col-md-6">
                        <h6><i class="fas fa-tree me-2"></i>Isolation Forest Parameters</h6>
                        
                        <div class="mb-3">
                            <label for="contamination" class="form-label">Contamination Rate</label>
                            <input type="number" class="form-control" id="contamination" name="contamination" 
                                   value="0.002" step="0.001" min="0.001" max="0.5">
                            <div class="form-text">Expected proportion of fraud transactions (0.1% - 50%)</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="n_estimators_iso" class="form-label">Number of Trees</label>
                            <input type="number" class="form-control" id="n_estimators_iso" name="n_estimators_iso" 
                                   value="100" min="10" max="500">
                            <div class="form-text">Number of isolation trees (10-500)</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="max_samples" class="form-label">Max Samples</label>
                            <select class="form-select" id="max_samples" name="max_samples">
                                <option value="auto" selected>Auto</option>
                                <option value="256">256</option>
                                <option value="512">512</option>
                                <option value="1024">1024</option>
                            </select>
                            <div class="form-text">Maximum number of samples to draw from data</div>
                        </div>
                    </div>
                    
                    <!-- Logistic Regression Parameters -->
                    <div class="col-md-6">
                        <h6><i class="fas fa-chart-line me-2"></i>Logistic Regression Parameters</h6>
                        
                        <div class="mb-3">
                            <label for="max_iter" class="form-label">Max Iterations</label>
                            <input type="number" class="form-control" id="max_iter" name="max_iter" 
                                   value="1000" min="100" max="5000">
                            <div class="form-text">Maximum iterations for convergence (100-5000)</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="solver" class="form-label">Solver</label>
                            <select class="form-select" id="solver" name="solver">
                                <option value="liblinear" selected>liblinear</option>
                                <option value="lbfgs">lbfgs</option>
                                <option value="saga">saga</option>
                                <option value="newton-cg">newton-cg</option>
                            </select>
                            <div class="form-text">Algorithm for optimization</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="penalty" class="form-label">Regularization</label>
                            <select class="form-select" id="penalty" name="penalty">
                                <option value="l2" selected>L2 (Ridge)</option>
                                <option value="l1">L1 (Lasso)</option>
                                <option value="none">None</option>
                            </select>
                            <div class="form-text">Type of regularization</div>
                        </div>
                    </div>
                </div>
                
                <!-- Ensemble Parameters -->
                <div class="row mt-4">
                    <div class="col-12">
                        <h6><i class="fas fa-layer-group me-2"></i>Ensemble Parameters</h6>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="iso_weight" class="form-label">Isolation Forest Weight</label>
                            <input type="range" class="form-range" id="iso_weight" name="iso_weight" 
                                   min="0.1" max="0.9" step="0.1" value="0.3" oninput="updateWeights()">
                            <div class="d-flex justify-content-between">
                                <small>0.1</small>
                                <small id="iso_weight_value">0.3</small>
                                <small>0.9</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="log_weight" class="form-label">Logistic Regression Weight</label>
                            <input type="range" class="form-range" id="log_weight" name="log_weight" 
                                   min="0.1" max="0.9" step="0.1" value="0.7" readonly>
                            <div class="d-flex justify-content-between">
                                <small>0.1</small>
                                <small id="log_weight_value">0.7</small>
                                <small>0.9</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Training Options -->
                <div class="row mt-4">
                    <div class="col-12">
                        <h6><i class="fas fa-cog me-2"></i>Training Options</h6>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="test_size" class="form-label">Test Split Size</label>
                            <select class="form-select" id="test_size" name="test_size">
                                <option value="0.1">10%</option>
                                <option value="0.2" selected>20%</option>
                                <option value="0.3">30%</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="random_state" class="form-label">Random Seed</label>
                            <input type="number" class="form-control" id="random_state" name="random_state" 
                                   value="42" min="1" max="1000">
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="cross_validation" class="form-label">Cross Validation</label>
                            <select class="form-select" id="cross_validation" name="cross_validation">
                                <option value="false">Disabled</option>
                                <option value="true" selected>5-Fold CV</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary btn-lg me-3" {% if transaction_count == 0 %}disabled{% endif %}>
                            <i class="fas fa-play me-2"></i>Train Models with Custom Parameters
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="validateParameters()">
                            <i class="fas fa-check me-2"></i>Validate Parameters
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Training Progress -->
    <div class="card" id="progressCard" style="display: none;">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-spinner fa-spin me-2"></i>Training Progress
            </h5>
        </div>
        <div class="card-body">
            <div class="progress mb-3">
                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" style="width: 0%" id="progressBar"></div>
            </div>
            <p id="progressText">Initializing...</p>
        </div>
    </div>
</div>

<script>
function updateWeights() {
    const isoWeight = parseFloat(document.getElementById('iso_weight').value);
    const logWeight = 1.0 - isoWeight;
    
    document.getElementById('iso_weight_value').textContent = isoWeight.toFixed(1);
    document.getElementById('log_weight_value').textContent = logWeight.toFixed(1);
    document.getElementById('log_weight').value = logWeight;
}

function loadDefaultParameters() {
    document.getElementById('contamination').value = '0.002';
    document.getElementById('n_estimators_iso').value = '100';
    document.getElementById('max_samples').value = 'auto';
    document.getElementById('max_iter').value = '1000';
    document.getElementById('solver').value = 'liblinear';
    document.getElementById('penalty').value = 'l2';
    document.getElementById('iso_weight').value = '0.3';
    document.getElementById('test_size').value = '0.2';
    document.getElementById('random_state').value = '42';
    document.getElementById('cross_validation').value = 'true';
    updateWeights();
}

function validateParameters() {
    const contamination = parseFloat(document.getElementById('contamination').value);
    const nEstimators = parseInt(document.getElementById('n_estimators_iso').value);
    const maxIter = parseInt(document.getElementById('max_iter').value);
    
    let messages = [];
    
    if (contamination < 0.001 || contamination > 0.5) {
        messages.push('Contamination rate should be between 0.1% and 50%');
    }
    
    if (nEstimators < 10 || nEstimators > 500) {
        messages.push('Number of trees should be between 10 and 500');
    }
    
    if (maxIter < 100 || maxIter > 5000) {
        messages.push('Max iterations should be between 100 and 5000');
    }
    
    if (messages.length === 0) {
        alert('All parameters are valid!');
    } else {
        alert('Parameter validation issues:\n' + messages.join('\n'));
    }
}

// Show progress when form is submitted
document.getElementById('trainingForm').addEventListener('submit', function() {
    document.getElementById('progressCard').style.display = 'block';
    updateProgress(0, 'Starting training...');
    
    // Simulate progress updates
    let progress = 0;
    const interval = setInterval(() => {
        progress += Math.random() * 20;
        if (progress > 90) {
            clearInterval(interval);
            progress = 90;
        }
        updateProgress(progress, `Training in progress... ${Math.round(progress)}%`);
    }, 1000);
});

function updateProgress(percent, text) {
    document.getElementById('progressBar').style.width = percent + '%';
    document.getElementById('progressText').textContent = text;
}

// Initialize weights on page load
updateWeights();
</script>
{% endblock %}