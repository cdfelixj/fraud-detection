{% extends "base.html" %}

{% block title %}Streaming Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <h2>Streaming Dashboard</h2>
            <p class="text-m    if (simulationActive) {
        // Stop simulation
        clearInterval(streamingInterval);
        simulationActive = false;
        toggleBtn.className = 'btn btn-success';
        toggleText.textContent = 'Start Stream';
    } else {
        // Start simulation
        simulationActive = true;
        toggleBtn.className = 'btn btn-danger';
        toggleText.textContent = 'Stop Stream';
        
        streamingInterval = setInterval(() => {
            updateSimulationData();
        }, 1000);
    }fraud detection with streaming data processing</p>
        </div>
    </div>
    
    <!-- System Status Row -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-info">
                <div class="card-body text-center">
                    <h5 class="card-title">Kafka Status</h5>
                    <div id="kafka-status" class="h3">
                        <span class="badge badge-secondary">Checking...</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-success">
                <div class="card-body text-center">
                    <h5 class="card-title">Processing Rate</h5>
                    <div id="processing-rate" class="h3">
                        <span class="text-primary">0 TPS</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-warning">
                <div class="card-body text-center">
                    <h5 class="card-title">Live Alerts</h5>
                    <div id="live-alerts" class="h3">
                        <span class="text-danger">0</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-primary">
                <div class="card-body text-center">
                    <h5 class="card-title">Total Processed</h5>
                    <div id="live-total-transactions" class="h3">
                        <span class="text-primary">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Stream Control -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Stream Control</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label>Rate (TPS)</label>
                            <input type="number" class="form-control" id="tps-input" value="10" min="1" max="1000">
                        </div>
                        <div class="col-md-6">
                            <label>Fraud Rate (%)</label>
                            <input type="number" class="form-control" id="fraud-rate-input" value="2" min="0" max="50" step="0.1">
                        </div>
                    </div>
                    <button type="button" class="btn btn-success" id="simulation-toggle" onclick="toggleStreamingSimulation()">
                        <span id="simulation-toggle-text">Start Stream</span>
                    </button>
                    <button type="button" class="btn btn-primary" onclick="updateStreamConfig()">Update Config</button>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Quick Actions</h5>
                </div>
                <div class="card-body">
                    <button type="button" class="btn btn-success btn-sm" onclick="sendTestTransaction()">Test Transaction</button>
                    <button type="button" class="btn btn-warning btn-sm" onclick="sendFraudTransaction()">Test Fraud</button>
                    <button type="button" class="btn btn-info btn-sm" onclick="enableBurstMode()">Burst Mode</button>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="refreshDatabaseStats()">Refresh</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Essential Charts -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h6><i class="fas fa-chart-line me-2"></i>Transaction Flow</h6>
                </div>
                <div class="card-body">
                    <canvas id="transactionFlowChart" height="200"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h6><i class="fas fa-chart-bar me-2"></i>Fraud Detection Rate</h6>
                </div>
                <div class="card-body">
                    <canvas id="liveAmountDistChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Live Transaction Feed -->
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5>Live Transaction Feed</h5>
                    <div class="float-right">
                        <button class="btn btn-sm btn-primary" onclick="toggleLiveFeed()">
                            <span id="feed-toggle-text">Start Feed</span>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="live-feed" style="height: 300px; overflow-y: auto; background: #212529; color: #fff; border: 1px solid #495057; padding: 15px; font-family: monospace; font-size: 12px; border-radius: 5px;">
                        <div class="text-muted">Live transaction feed will appear here...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5>Recent Transactions</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive" style="height: 300px; overflow-y: auto;">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="live-transaction-table">
                                <tr>
                                    <td colspan="3" class="text-center text-muted">
                                        Start streaming to see transactions
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let liveFeedActive = false;
let liveFeedInterval;
let simulationActive = false;
let streamingInterval;

// Chart variables
let transactionFlowChart;
let liveAmountDistChart;

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    checkKafkaHealth();
});

// Check Kafka health
function checkKafkaHealth() {
    fetch('/kafka/health')
    .then(response => response.json())
    .then(data => {
        const kafkaStatus = document.getElementById('kafka-status');
        if (data.kafka_status && data.kafka_status.kafka_connected) {
            kafkaStatus.innerHTML = '<span class="badge badge-success">Connected</span>';
        } else {
            kafkaStatus.innerHTML = '<span class="badge badge-danger">Disconnected</span>';
        }
    })
    .catch(error => {
        console.error('Kafka health check error:', error);
        document.getElementById('kafka-status').innerHTML = '<span class="badge badge-danger">Error</span>';
    });
}

// Initialize charts
function initializeCharts() {
    // Transaction Flow Chart
    const ctx1 = document.getElementById('transactionFlowChart');
    if (ctx1) {
        transactionFlowChart = new Chart(ctx1, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Transactions/sec',
                    data: [],
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { display: false },
                    y: { beginAtZero: true }
                },
                plugins: { legend: { display: false } }
            }
        });
    }

    // Fraud Detection Chart
    const ctx2 = document.getElementById('liveAmountDistChart');
    if (ctx2) {
        liveAmountDistChart = new Chart(ctx2, {
            type: 'doughnut',
            data: {
                labels: ['Normal', 'Fraud'],
                datasets: [{
                    data: [95, 5],
                    backgroundColor: ['#28a745', '#dc3545']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } }
            }
        });
    }
}

// Toggle streaming simulation
function toggleStreamingSimulation() {
    const toggleBtn = document.getElementById('simulation-toggle');
    const toggleText = document.getElementById('simulation-toggle-text');
    
    if (simulationActive) {
        // Stop simulation
        clearInterval(streamingInterval);
        simulationActive = false;
        toggleBtn.className = 'btn btn-success';
        toggleText.textContent = 'Start Stream';
    } else {
        // Start simulation
        simulationActive = true;
        toggleBtn.className = 'btn btn-danger';
        toggleText.textContent = 'Stop Stream';
        
        streamingInterval = setInterval(() => {
            updateSimulationData();
        }, 1000);
    }
}

// Update simulation data
function updateSimulationData() {
    const tps = parseInt(document.getElementById('tps-input').value) || 10;
    const fraudRate = parseFloat(document.getElementById('fraud-rate-input').value) || 2;
    
    // Update counters
    const currentTotal = parseInt(document.getElementById('live-total-transactions').textContent) || 0;
    const newTotal = currentTotal + tps;
    const fraudCount = Math.floor(newTotal * fraudRate / 100);
    
    document.getElementById('live-total-transactions').textContent = newTotal;
    document.getElementById('processing-rate').innerHTML = `<span class="text-primary">${tps} TPS</span>`;
    document.getElementById('live-alerts').innerHTML = `<span class="text-danger">${fraudCount}</span>`;
    
    // Update charts
    updateCharts(tps, fraudCount);
    
    // Update live feed
    if (liveFeedActive) {
        addToLiveFeed(`Processed ${tps} transactions (${Math.floor(tps * fraudRate / 100)} fraud detected)`, 'info');
    }
    
    // Update transaction table
    updateTransactionTable(tps, fraudRate);
}

// Update charts with new data
function updateCharts(tps, fraudCount) {
    const timestamp = new Date().toLocaleTimeString();
    
    // Update transaction flow chart
    if (transactionFlowChart) {
        if (transactionFlowChart.data.labels.length >= 30) {
            transactionFlowChart.data.labels.shift();
            transactionFlowChart.data.datasets[0].data.shift();
        }
        transactionFlowChart.data.labels.push(timestamp);
        transactionFlowChart.data.datasets[0].data.push(tps);
        transactionFlowChart.update('none');
    }
    
    // Update fraud detection chart
    if (liveAmountDistChart) {
        const total = parseInt(document.getElementById('live-total-transactions').textContent) || 1;
        const normal = total - fraudCount;
        liveAmountDistChart.data.datasets[0].data = [normal, fraudCount];
        liveAmountDistChart.update('none');
    }
}

// Update transaction table
function updateTransactionTable(tps, fraudRate) {
    const tableBody = document.getElementById('live-transaction-table');
    const time = new Date().toLocaleTimeString();
    
    // Add a few sample transactions
    for (let i = 0; i < Math.min(3, tps); i++) {
        const isfraud = Math.random() < (fraudRate / 100);
        const amount = (Math.random() * 1000 + 10).toFixed(2);
        
        const row = tableBody.insertRow(0);
        row.innerHTML = `
            <td>${time}</td>
            <td>$${amount}</td>
            <td><span class="badge badge-${isfraud ? 'danger' : 'success'}">${isfraud ? 'FRAUD' : 'Normal'}</span></td>
        `;
        
        // Keep only last 10 rows
        while (tableBody.rows.length > 10) {
            tableBody.deleteRow(-1);
        }
    }
}

// Live feed functions
function toggleLiveFeed() {
    const toggleBtn = document.getElementById('feed-toggle-text');
    
    if (liveFeedActive) {
        clearInterval(liveFeedInterval);
        liveFeedActive = false;
        toggleBtn.textContent = 'Start Feed';
    } else {
        liveFeedActive = true;
        toggleBtn.textContent = 'Stop Feed';
        addToLiveFeed('Live feed started', 'success');
    }
}

function addToLiveFeed(message, type = 'info') {
    const feed = document.getElementById('live-feed');
    const timestamp = new Date().toLocaleTimeString();
    const color = type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8';
    
    const entry = document.createElement('div');
    entry.innerHTML = `<span style="color: #6c757d;">[${timestamp}]</span> <span style="color: ${color};">${message}</span>`;
    
    feed.insertBefore(entry, feed.firstChild);
    
    // Keep only last 50 entries
    while (feed.children.length > 50) {
        feed.removeChild(feed.lastChild);
    }
}

// Configuration and test functions
function updateStreamConfig() {
    const tps = document.getElementById('tps-input').value;
    addToLiveFeed(`Configuration updated: ${tps} TPS`, 'success');
}

function sendTestTransaction() {
    const amount = (Math.random() * 1000 + 10).toFixed(2);
    addToLiveFeed(`Test transaction sent: $${amount}`, 'success');
}

function sendFraudTransaction() {
    const amount = (Math.random() * 5000 + 1000).toFixed(2);
    addToLiveFeed(`🚨 Fraud test transaction sent: $${amount}`, 'error');
}

function enableBurstMode() {
    document.getElementById('tps-input').value = 100;
    addToLiveFeed('Burst mode enabled (100 TPS)', 'info');
}

function refreshDatabaseStats() {
    addToLiveFeed('Database stats refreshed', 'info');
}
</script>


{% endblock %}
